<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>Puzzle Game Demo</title>
<style>

#puzzle {
	position:relative;
	padding:20px;
	width:200px;
	height:200px;
}
#puzzle a {
	position:absolute;
	display:block;
	border:0px solid green;
	width:90px;
	height:90px;

	background:url(http://4.bp.blogspot.com/-3F84Y9GQkwI/TzaASbnKohI/AAAAAAAASNQ/KAq0xKRAdqM/s1600/zooey_deschanel.jpg) no-repeat 0 0;
/*	background:url(http://images.wikia.com/stephenking/images/f/ff/Clown.png) no-repeat 0 0;
*/

/*	background:url(http://3.bp.blogspot.com/_SPYL8UC1UCY/TJ5k7SBhwwI/AAAAAAAAD8Q/XEYiYGjGKQw/s1600/Harold+Lloyd.jpg) no-repeat 0 0;
	background-size:800px 800px;

*/	text-decoration:none;
}
#puzzle a span {
/*display:none;*/

	position:absolute;
	top:3px;
	left:3px;
	display:block;
	padding:2px;
	color:#f00;
	background-color:#fff;
}

</style>
<script>

var puz = {

	/* config */
	board_w: 4,
	board_h: 4,
	tile_size: 90,
	tile_spacing:4,
	slide_delay: 100,
	slide_event: 'onclick',

	/* in game vars */
	board: [],
	space: [0, 0],
	game_in_progress: false,
	board_active: false,
	start_time:0,
	end_time:0,
	moves:0,
	last_tile_moved:0,
	
	btn_start: '<a href="#start" onclick="puz.start_game(); return false">Start Game</a>',
	btn_reset: '<a href="#reset" onclick="puz.init(); return false">Reset</a>',
	
	/* transition settings */
	transition: false,
	
	styles: {
		'.puzzle' : {
			'position': 'relative'
		},
		'.puzzle a' : {
			'position': 'absolute',
			'display': 'block',
			'width': '90px',
			'height': '90px',
			'background-image': 'url(http://3.bp.blogspot.com/_SPYL8UC1UCY/TJ5k7SBhwwI/AAAAAAAAD8Q/XEYiYGjGKQw/s1600/Harold+Lloyd.jpg)',
			'background-repeat': 'no-repeat',
//			'background-size': '400px 400px';
			'text-decoration': 'none',
		},
		'.puzzle a span' : {
			'display': 'none'
		}
	},
	
	init: function() {
		if (document.ontouchstart) puz.slide_event = "ontouchstart";
		puz.reset_game();
		puz.build_board_map();
		puz.build_board();
		puz.transition_dist = puz.tile_size + puz.tile_spacing;
		puz.transition = puz.transition_vars()
	},

	reset_game: function() {
		puz.board_active = false;
		puz.start_time = 0;
		puz.end_time = 0;
		puz.game_in_progress = false;
		puz.moves = 0;
		puz.last_tile_moved = 0
		document.getElementById('moves').innerHTML = '0';
		document.getElementById('time').innerHTML = '0';
		document.getElementById('button').innerHTML = puz.btn_start;
	},
	
	start_game:function() {
		puz.reset_game()
		puz.moves = 0;
		document.getElementById('button').innerHTML = "&nbsp;"
		puz.mix_board(puz.go);
	},
	
	go: function () {
		document.getElementById('button').innerHTML = puz.btn_reset;
		puz.start_time = new Date();
		puz.game_in_progress = true;
		puz.board_active = true;
		puz.time_disp();
	},
	
	build_board: function() {
		var tiles = (puz.board_w * puz.board_h) - 1,
			h = '',
			top = 0,
			left = 0,
			pos = "";
		puz.board_el = document.getElementById('puzzle');
		for (var i=1; i<=tiles; i++) {
			top = Math.floor(i/(puz.board_w+.1));
			left = ((i-1) % puz.board_w);
			var top_pos = top*puz.tile_size + (puz.tile_spacing * top),
				left_pos = left*puz.tile_size + (puz.tile_spacing * left)
			h += '<a href="#shift" id="tile'+i+'" \
					style="top:'+ top_pos +'px;\
					left:'+left_pos+'px;\
					background-position: -'+left_pos+'px -'+top_pos+'px\
					" ' + puz.slide_event + '="return puz.slide_click(this);"><span>'+i+'</span></a>';
		}	
		puz.board_el.innerHTML = h;
	},

	build_board_map: function() {
		/*
		builds a programmatical map of the board
		*/
		puz.board = [];
		for (var i=0;i<puz.board_h;i++) {
			var arr = [];
			for (var q=1;q<=puz.board_w;q++) {
				arr.push(q + (puz.board_w*i))
			}
			puz.board.push(arr);
		}
		// make the 'space' in the bottom right tile
		puz.board[puz.board_h-1][puz.board_w-1] = 0;
		puz.space = [puz.board_h - 1, puz.board_w - 1];			
	},
	
	mix_board: function(callback) {
		/*
			moves tiles randomly until the board is mixed
		*/
		var moves = 0,
			total_time = 0,//(puz.board_w * puz.board_h * 4 * puz.slide_delay),
			slide_delay = puz.slide_delay;
			slide_tile = function() {
				var tiles = puz.movable_tiles();
				do {
					var rnd = parseInt(tiles.length * Math.random());
					tile_num = tiles.splice(rnd, 1)
				} while (tile_num == puz.last_tile_moved)
				var to = puz.slide_invoke(document.getElementById("tile" + tile_num))
			}
//		if (total_time > 20000) puz.active_slide_delay = 1;
//		while (moves < 1) {
		while (moves < (puz.board_w * puz.board_h * 4)) {
			var delay = (slide_delay * moves);
			setTimeout(slide_tile, delay);
			moves++;
		}
		puz.cback = setTimeout(callback, delay + 1000);
	},

	print_debug: function() {
		puz.print_board_map();
		puz.print_space();
		puz.print_movable_tiles();
	},

	print_space: function() {
		document.getElementById("debug_space").innerHTML = puz.space.toString();
	},

	print_movable_tiles: function() {
		document.getElementById("debug_movable").innerHTML = puz.movable_tiles().toString();
	},

	print_board_map: function() {
		var h = ""
		var two_digits = function(digit) {
			if (digit < 10) return "0" + digit;
			return digit;
		}
		for (var row=0,len =puz.board.length ; row<len; row++) {
			for (var col=0, lim=puz.board[row].length; col<lim; col++) {
				h += two_digits(puz.board[row][col]) + " "
			}
			h += "<br />"
		}
		if (!puz.debug_el) puz.debug_el = document.getElementById("debug");
		puz.debug_el.innerHTML = h;
	},
	
	movable_tiles: function (dir) {
		var tiles = [],
			x = puz.space[0],
			y = puz.space[1];
			if (x>0) tiles.push(puz.board[y][x-1]);
			if (x<puz.board_w-1) tiles.push(puz.board[y][x+1]);
			if (y>0) tiles.push(puz.board[y-1][x]);
			if (y<puz.board_h-1) tiles.push(puz.board[y+1][x]);
			return tiles;
	},
	
	slide_click: function(el) {
		if (puz.board_active) {
			puz.slide_invoke(el);
		}
		return false;
	},

	find_tile: function (id) {
		/*
		function that searchs the board map adn returns x and y coordinates
		*/
		var x, y; 
		for (var row in puz.board) {
			y = row;
			for (var col in puz.board[row]) {
				if (puz.board[row][col] === id) {
					return [col, y];
				}
			}
		}
	},

	slide_invoke:function(el) {
		var curr = el.id;
		var curr_num = parseInt(curr.replace('tile',''));
		// compare the slide pos to the space pos.
		// which way can we slide? up, down, left or right?
		var coods = puz.find_tile(curr_num);
		var x_diff = puz.space[0] - coods[0],
			y_diff = puz.space[1] - coods[1];
		// one axis value has to be the same and the other within 1
		if (((Math.abs(x_diff) == 1) && (y_diff == 0)) || ((Math.abs(y_diff) == 1) && (x_diff == 0))) {
			puz.slide_start(el, x_diff, y_diff);
			return true;
		}
		return false;
	},
	
	slide_start: function(el, x_dir, y_dir) {
		puz.board_active = false;
		puz.last_tile_moved = el;
		var x_st = parseInt(el.style.left),
			y_st = parseInt(el.style.top);
		if (puz.transition) {
			var transitionEnd = function() {
				// cancel the transition stuff & then call puz.slide()
				el = puz.last_tile_moved;
				el.style[puz.transition.property + 'Duration'] = "0";
				el.style[puz.transition.transform] = "translate3d(0, 0, 0)";
				puz.slide(el, x_st, y_st, x_dir, y_dir);
			}
/*
NOTE: not using event Listeners here because they can't be removed reliably x-browser :(
August 2012
*/
			var delay = Math.floor(puz.slide_delay * .75);
			if (puz.cleanUp) clearTimeout(puz.cleanUp);
			puz.cleanUp = setTimeout(transitionEnd, delay + 10)
			el.style[puz.transition.property + 'Duration'] =  delay + "ms";
			el.style[puz.transition.transform] = "translate3d(" + (x_dir * puz.transition_dist) + "px, " + ( y_dir * puz.transition_dist) + "px, 0)";
		}
		else {
			puz.slide(el, x_st, y_st, x_dir, y_dir);
		}
	},

	slide: function(el, x_st, y_st, x_dir, y_dir) {
		el.style.left = x_st + (x_dir * puz.transition_dist) + "px";
		el.style.top =  y_st  + (y_dir * puz.transition_dist) + "px";
		puz.slide_finish(el, x_dir, y_dir);
	},
	
	slide_finish: function(el, x_dir, y_dir) {
		// update board_game
		var tile_num = parseInt(el.id.replace('tile', ''));
		puz.board[puz.space[1]][puz.space[0]] = tile_num;
		puz.last_tile_moved = tile_num;
		// change the stored 'space' co-ods
		puz.space[0] = puz.space[0] - x_dir;
		puz.space[1] = puz.space[1] - y_dir;
		puz.board[puz.space[1]][puz.space[0]] = 0;
		if (puz.start_time) {
			puz.moves++;
			puz.display_moves();
			if (!puz.check_game_state()) puz.board_active = true;
			else puz.game_complete();
		}
//		puz.print_debug();
	},

	check_game_state: function() {
		/*
		check the board map to see if the puzzle has been solved
		*/
		var counter = 1
		for (var row in puz.board) {
			for (var col in puz.board[row]) {
				if ((puz.board[row][col] != counter) && (counter < puz.board_w * puz.board_h)) return false; 
				counter++;
			} 
		}
		return true
	},

	
	time_diff: function(start, end) {
		return end.getTime() - start.getTime();
	},

	time_format: function(ms) {
		var hrs = Math.floor(ms / (1000 * 60 * 60));
		var rmndr = ms - (1000 * 60 * 60 * hrs);
		var mins = Math.floor(rmndr / (60 * 1000))
		rmndr = rmndr - (60 * 1000 * mins)
		var secs = Math.floor(rmndr/1000);
		return hrs + ":" + puz.pad_num(mins) + ":" + puz.pad_num(secs);
	},
	
	pad_num: function(num) {
		return (num < 10) ? '0' + num : num;
	},
	
	time_disp: function() {
		if (puz.game_in_progress) {
			document.getElementById('time').innerHTML = puz.time_format(puz.time_diff(puz.start_time, new Date()))
			puz.clock = setTimeout(puz.time_disp, 49);
		}
	},
	
	display_moves: function() {
		document.getElementById('moves').innerHTML = puz.moves;
	},
	
	game_complete: function() {
		puz.end_time = new Date();
		alert("You did it!\nYou took " + puz.moves + " moves.\nTime taken " + puz.time_format(puz.time_diff(puz.start_time, puz.end_time)));
		document.getElementById('button').innerHTML = puz.btn_start;
		puz.game_in_progress = false;
		puz.board_active = false;
	},
	
	transition_vars: function() {
		var el = document.createElement('div'),
			poss = [
			["transition", 'transition', 'transitionend', "transform" ],
			["WebkitTransition", '-webkit-transition', 'webkitTransitionEnd', "webkitTransform"],
			["MSTransition", '-ms-transition', 'MSTransitionEnd', "MSTransform" ],
			["MozTransition", '-moz-transition', 'transitionend', "MozTransform" ],
			["OTransition", '-o-transition', 'OTransitionEnd', "OTransform" ]
		];
		for (var p in poss) {
			if (poss[p][0] in el.style) {
				return {
					'property': poss[p][0],
					'cssName': poss[p][1],
					'event': poss[p][2],
					'transform': poss[p][3] 
				}
				break;
			}
		}
		return false;
	}
};


window.addEventListener('load', function() {
	puz.init();
});




</script>


</head>
<body>

<p id="button"><a href="#start" onclick="puz.start_game(); return false">Start Game</a></li></p>

<ul>
	<li>Time <span id="time">0</span></li>
	<li>Moves <span id="moves">0</span></li>
</ul>

<p id="puzzle">

</p>

<div id="debug_wrap" style="font-family:courier;position:absolute;right:1em; top:1em">
	<div id="debug"></div>
	<div>Space: <span id="debug_space"></span></div>
	<div>Movable: <span id="debug_movable"></span></div>
</div>


</body>
</html>
